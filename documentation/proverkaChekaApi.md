ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ




API-ИНТЕРФЕЙС
сервисА «Проверка чека онлайн»
Оглавление
1.	Общие положения	3
      1.1.	Цели и задачи документа	3
      1.2.	Определения и сокращения	3
2.	Описание API-интерфейса сервиса	4
      2.1.	Подключение	4
      2.2.	Статистика запросов	4
      2.3.	Форматы запросов	4
      2.3.1.	Формат запроса 1	4
      2.3.2.	Формат запроса 2	4
      2.3.3.	Формат запроса 3	5
      2.3.4.	Формат запроса 4	5
      2.4.	Формат ответа	5
      2.5.	Использование QR-кодов	6
      2.6.	Пример запроса к сервису через curl	6
      2.7.	Пример запроса к сервису на языке Python	7
      2.8.	Пример запроса к сервису на языке PHP	7
      2.9.	Пример запроса к сервису на языке JavaScript	8
      2.10.	Параметр запроса API для идентификации акции	8
      2.11.	Добавление произвольных параметров к запросу	9
      2.12.	Виджет для запуска акции	9
      2.13.	Использование программных библиотек и примеры подключения	9



    1. Общие положения
        1.1. Цели и задачи документа
В документе представлена вся необходимая информация по использованию API-интерфейса сервиса «Проверка чека онлайн» для получения кассового чека по его реквизитам.

        1.2. Определения и сокращения
Использованы термины и сокращения:
API – интерфейс - интерфейс программирования приложений, который позволяет отправлять и получать данные сервиса «Проверка чека онлайн» расположенный на веб-сайте.
БД – база данных.
Веб-сайт – источник информации, размещенный в сети Интернет.
Пользователь – лицо, заключившее договор на условиях настоящей Технической спецификации с поставщиком услуги API – интерфейса в интересах владельца Приложения Пользователя.
Приложение Пользователя — Интернет-площадка и прочие Веб-приложения (включая мобильные), принадлежащие или используемые Пользователем на законных основаниях под собственным товарным знаком или иным средством индивидуализации, с помощью которых Продукты показываются и/или доводятся до сведения Потребителей.
Потребитель — любое лицо, использующее Приложение Пользователя по функциональному назначению.
Ключ доступа — предоставляемая Пользователю уникальная комбинация знаков, ассоциированная с Идентификатором Приложения Пользователя и позволяющая обеспечить программное взаимодействие Приложения Пользователя к API – интерфейсу посредством Запросов.
Запрос — поступивший от сервера Пользователя к API – интерфейсу http-запрос, строго соответствующий указанным в Технической спецификации параметрам.
Успешный запрос – запрос на который был получен ответ от API – интерфейса.

    2. Описание API-интерфейса сервиса 
        2.1. Подключение 
Для получения доступа к API-интерфейсу сервиса Пользователю необходимо направить заявку на подключение с указанием следующих сведений:
• Адрес Интернет-площадки или название Веб-приложения;
• Тематику Приложения Пользователя;
• Идентифицирующие Пользователя данные;
• Адрес электронной почты Пользователя для отправки Ключа доступа.

        2.2. Статистика запросов
Для получения статистики Запросов Пользователя к API-интерфейсу необходимо в личном кабинете на сайте проверка чека перейти в пункт меню «Сервис» - «Статистика». На странице выведется информация с разбивкой по месяцам о количестве успешных/неуспешных обращений к API.

        2.3. Форматы запросов
            2.3.1. Формат запроса 1
POST https://proverkacheka.com/api/v1/check/get
Тип содержимого: application/json, application/x-www-form-urlencoded, multipart/form-data
Тело запроса:
token – Токен доступа
fn - Номер фискального накопителя
fd - Номер фискального документа
fp - Фискальный признак документа
t - Дата и время
n - Тип операции (Приход/Возврат прихода/Расход/Возврат расхода)
s - Сумма чека в рублях (например: 75.54)
qr – Признак сканирования qr кода (0/1)
2.3.2. Формат запроса 2
POST https://proverkacheka.com/api/v1/check/get
Тип содержимого: application/json, application/x-www-form-urlencoded, multipart/form-data
Тело запроса:
qrraw - строка сырых данных QR-кода, например:
t=20200924T1837&s=349.93&fn=9282440300682838&i=46534&fp=1273019065&n=1
При передаче qrraw сервис обработает строку, закодированную в qr коде и
получит чек.
2.3.3. Формат запроса 3
POST https://proverkacheka.com/api/v1/check/get
Тип содержимого: application/json, application/x-www-form-urlencoded, multipart/form-data
Тело запроса:
qrurl - ссылка на картинку QR-кода, например: https://domen.ru/image/qrimage.jpg
При передаче qrurl сервис скачает картинку, распознает по ней код и получит чек.
2.3.4. Формат запроса 4
POST https://proverkacheka.com/api/v1/check/get
Тип содержимого: multipart/form-data
Тело запроса:
qrfile - содержимое файла картинки QR-кода
При передаче qrfile сервис получит картинку из запроса, распознает по
ней код и получит чек.
2.4. Формат ответа

Наименование ключа
Значение ключа
code
КОД ОТВЕТА:
0 - чек некорректен,
1 - данные чека получены (успешный запрос),
2 - данные чека пока не получены,
3 - превышено кол-во запросов,
4 - ожидание перед повторным запросом,
5 - прочее (данные не получены)
first
Признак повторного получения информации по чеку:
1 - информация по чеку получена впервые
0 - информация по чеку получена повторно
data
ДАННЫЕ
data.json
ДАННЫЕ В ФОРМАТЕ JSON
data.json.user
Организация
data.json.retailPlaceAddres
Адрес
data.json.userInn
ИНН
data.json.ticketDate
Дата
data.json.requestNumber
Чек: №
data.json.shiftNumber
Смена
data.json.operator
Кассир
data.json.operationType
Тип операции:
1 - Приход
2 - Возврат прихода
3 - Расход
4 - Возврат расхода
data.json.items
ПОЗИЦИИ ТОВАРА/УСЛУГИ (массив)
data.json.items[i]
Позиция в чеке (элемент массива позиций)
data.json.items[i].name
Название товара/услуги
data.json.items[i].price
Цена
data.json.items[i].quantity
Количество
data.json.items[i].sum
Сумма (в коп.)
data.json.nds18
НДС со ставкой 20% (сумма в коп.)
data.json.nds
НДС со ставкой 10% (сумма в коп.)
data.json.nds0
НДС со ставкой 0%   (сумма в коп.)
data.json.ndsNo
НДС не облагается    (сумма в коп.)
data.json.totalSum
ИТОГО (сумма в коп.)
data.json.cashTotalSum
Наличные (сумма в коп.)
data.json.ecashTotalSum
Карта (сумма в коп.)
data.json.taxationType
ВИД НАЛОГООБЛОЖЕНИЯ:
1 - ОСН,
2 - УСН,
4 - УСН доход – расход,
8 - ЕНВД,
16 - ЕСХН,
32 - ПСН
data.json.kktRegId
РЕГ. НОМЕР ККТ
data.json.kktNumber
ЗАВОД. №
data.json.fiscalDriveNumber
ФН
data.json.fiscalDocumentNumber
ФД
data.json.fiscalSign
ФПД
data.html
ДАННЫЕ В ФОРМАТЕ HTML
request
ИСХОДНЫЕ ДАННЫЕ ЗАПРОСА
request.qrurl
Ссылка на картинку QR-кода
request.qrfile
Уникальный идентификатор файла картинки QR-кода
request.qrraw
Строка сырых данных QR-кода
request.manual
ПРИВЕДЕННЫЕ ПАРАМЕТРЫ ДАННЫХ ЗАПРОСА
request.manual.fn
ФН
request.manual.fd
ФД
request.manual.fp
ФПД
request.manual.check_time
Дата и время
request.manual.type
Тип операции:
1 - Приход
2 - Возврат прихода
3 - Расход
4 - Возврат расхода
request.manual.sum
ИТОГО (сумма в рублях)

        2.5. Использование QR-кодов
Содержимое QR кода кассового чека содержит строку следующего формата:
t=20190202T1044&s=476.00&fn=9289000100054082&i=16112&fp=399448105&n=1
Параметры:
t - Дата и время
s - Сумма чека
fn - Номер фискального накопителя
i - Номер фискального документа
fp - Фискальный признак документа
n - Тип операции (Приход/Возврат прихода/Расход/Возврат расхода)
2.6. Пример запроса к сервису через curl

#пример параметров формата запроса 1
curl https://proverkacheka.com/api/v1/check/get --data
"fn=9280440300770583&fd=33110&fp=4138469556&n=1&s=419.54&t=20210217T2028&qr=0&token=<здесь прописываем токен доступа>"

#пример параметров формата запроса 2
curl --location --request POST 'https://proverkacheka.com/api/v1/check/get' \
--form 'qrraw="t=20200924T1837&s=349.93&fn=9282440300682838&i=46534&fp=1273019065&n=1"' \
--form 'token="токен доступа"'

#пример параметров формата запроса 3
curl --location --request POST 'https://proverkacheka.com/api/v1/check/get' \
--form 'qrurl ="https://domen.ru/image/qrimage.jpg"' \
--form 'token="токен доступа"'

#пример параметров формата запроса 4
curl --location --request POST 'https://proverkacheka.com/api/v1/check/get' \
--form 'qrfile=@"путь до файла"' \
--form 'token="токен доступа"'



        2.7. Пример запроса к сервису на языке Python

import requests
url = 'https://proverkacheka.com/api/v1/check/get'

#пример параметров формата запроса 1
data={  'fn': '9280440300770583', //ФН
'fd' : '33110', //ФД
'fp': '4138469556', //ФП
't' : '20210217T2028', //время с чека
'n' : '1', //вид кассового чека
's' : '419.54', //сумма чека
'qr' : '0', //признак сканирования QR-кода
'token':'' //токен доступа
}

#пример параметров формата запроса 2
data={'token':'','qrraw': 't=20200924T1837&s=349.93&fn=9282440300682838&i=46534&fp=1273019065&n=1'}

#пример параметров формата запроса 3
data={'token':'','qrurl': 'https://domen.ru/image/qrimage.jpg'}

#пример параметров формата запроса 4
data={'token':''}
files = {'qrfile': open('файл-картинка','rb')}
r = requests.post(url, data=data, files=files)
print(r.text)

        2.8. Пример запроса к сервису на языке PHP
<?php
//пример параметров формата запроса 1
//параметры из формы запроса полученные от браузера клиента
$tPar=[
  'fn' => '9280440300770583', //ФН
  'fd' => '33110', //ФД
  'fp' => '4138469556', //ФП
  't' => '20210217T2028', //время с чека
  'n' => '1', //вид кассового чека
  's' => '419.54', //сумма чека
  'qr' => '0', //признак сканирования QR-кода
  'token' => '' //токен доступа
];

//пример параметров формата запроса 2
$tPar=[
  'qrraw' =>   't=20200924T1837&s=349.93&fn=9282440300682838&i=46534&fp=1273019065&n=1', //строка сырых данных QR-кода
  'token' => '' //токен доступа
];

//пример параметров формата запроса 3
$tPar=[
  'qrurl' => 'https://domen.ru/image/qrimage.jpg', //ссылка на картинку QR-кода
  'token' => '' //токен доступа
];

//пример параметров формата запроса 4
$localFile = $_FILES["scan"]['tmp_name'];
$filename = basename($localFile);
$tPar=[
  'token' => '', //токен доступа
  'qrfile' => curl_file_create($localFile, $_FILES['scan']['type'], $filename), //файл-картинка для обработки
];

//выполняем запрос на сервер Проверка чека используя API
$tСurl = curl_init();
curl_setopt($tСurl, CURLOPT_URL, https://proverkacheka.com/api/v1/check/get');
curl_setopt($tСurl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($tСurl, CURLOPT_POST, true);
curl_setopt($tСurl, CURLOPT_POSTFIELDS, $tPar);
$tRes = curl_exec($tСurl);
curl_close($tСurl);
?>


        2.9. Пример запроса к сервису на языке JavaScript

//пример 1
const encodedParams = new URLSearchParams();
encodedParams.append("qrraw", "t=20200924T1837&s=349.93&fn=9282440300682838&i=46534&fp=1273019065&n=1");
encodedParams.append("token", "<токен доступа>");

const options = {
method: 'POST',
headers: {
'content-type': 'application/x-www-form-urlencoded',
},
body: encodedParams
};

fetch('https://proverkacheka.com/api/v1/check/get', options)
.then(response => response.json())
.then(response => {
console.log(response);
document.querySelector('.b-res').innerHTML=response.data.html;
})
.catch(err => console.error(err));

//пример 2
const encodedParams = new URLSearchParams();
encodedParams.append("qrurl", "https://i.imgur.com/IVX4DgO.jpg");
encodedParams.append("token", "<токен доступа>");

const options = {
method: 'POST',
headers: {
'content-type': 'application/x-www-form-urlencoded',
},
body: encodedParams
};

fetch('https://proverkacheka.com/api/v1/check/get', options)
.then(response => response.json())
.then(response => {
console.log(response);
document.querySelector('.b-res').innerHTML=response.data.html;
})
.catch(err => console.error(err));


//пример 3
var tFormData = new FormData();
tFormData.append('qrfile', document.querySelector('.b-file').files[0]);
tFormData.append('token', "<токен доступа>");


const options = {
method: 'POST',
body: tFormData
};

fetch('https://proverkacheka.com/api/v1/check/get', options)
.then(response => response.json())
.then(response => {
console.log(response);
document.querySelector('.b-res').innerHTML=response.data.html;
})
.catch(err => console.error(err));

        2.10. Параметр запроса API для идентификации акции
Параметр необходимо указывать, если требуется чтобы все запросы чеков через API попадали в соответствующую акцию в личном кабинете. Откуда уже можно будет выгрузить информацию или вести статистику по акции.
Спецификация по параметрам к POST запросу:
- 'promo_id' //идентификатор акции из личного кабинета, тип - целое число
  Подробнее узнать о функционале промо-акций можно написав на почту webmaster@proverkacheka.com

        2.11. Добавление произвольных параметров к запросу
С отправкой чека через API возможно добавлять произвольные данные, связанные с данным чеком, для этого при запросе добавьте параметр по шаблону:
- userdata_<param_name> //строка данных, где <param_name> - имя параметра, например: userdata_name1="параметр1"
  При выгрузке чеков в формате json в структуре содержится атрибут user_data, который будет содержать добавленную информацию, для примера выше это поле "user_data.name1".
  Обратите внимание: при передаче данных userdata_name1, а в выгрузке user_data.name1

        2.12. Виджет для запуска акции
С помощью виджета от нашего сервиса можно быстро запустить промо-акцию, для этого необходимо встроить виджет на свой сайт, построенный с помощью конструктора Tilda, Wix и других.
Все чеки, поступающие от виджета проверяются по условиям акции в режиме реального времени, т.е. после отправки чека результат получаем сразу.
После окончания акции все чеки Вы можете выгрузить в Excel и подвести итоги(розыгрыш).
Подробнее узнать о виджете  можно написав нам на почту webmaster@proverkacheka.com

        2.13. Использование программных библиотек и примеры подключения
По адресу: https://proverkacheka.com/example/index.php содержится:
- форма запроса реквизитов для встраивания на сайт,
- подключаемые библиотеки JS, CSS для обработки распознавания QR кода и направления параметров запроса на ваш сайт,
- пример использования интерфейса API на вашем сайте с помощью PHP CURL.
